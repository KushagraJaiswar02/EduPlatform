<%- include('../partials/header') %>

<div class="container py-4">

  <!-- Page Heading -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h2 class="fw-bold text-primary mb-0 fade-in">Community Forum</h2>

    <form method="GET" action="/forum" class="d-flex">
      <select
        name="class"
        class="form-select form-select-sm rounded-3 smooth-select"
        style="min-width: 150px;"
        onchange="this.form.submit()">

        <option value="">All Classes</option>

        <% classes.forEach(cls => { %>
          <option value="<%= cls._id %>" <%= selectedClass == cls._id ? 'selected' : '' %>>
            Class <%= cls.classNumber %>
          </option>
        <% }) %>

      </select>
    </form>
  </div>

  <% if (forum && forum.length > 0) { %>

    <% forum.slice().reverse().forEach((post, i) => { %>

      <!-- Animated Forum Card -->
      <div class="card border-0 shadow-sm mb-4 rounded-4 forum-card animate-post" style="--i:<%= i %>">

        <!-- Header -->
        <div class="card-body pb-0 d-flex gap-3">

          <div class="avatar pulse"
               style="width: 48px; height: 48px; font-size: 1.1rem;">
            <%= post.askedBy?.name 
                  ? post.askedBy.name.split(' ').map(n=>n[0]).join('') 
                  : 'U' %>
          </div>

          <div class="flex-grow-1">
            <h5 class="fw-semibold mb-1"><%= post.subject %></h5>

            <div class="text-muted small mb-2">
              <%= post.askedBy ? post.askedBy.name : "Unknown User" %>
              &middot;
              <%= new Date(post.createdAt).toLocaleString() %>

              <% if (post.classRef) { %>
                &middot;
                <span class="ms-1">Class <strong><%= post.classRef.classNumber %></strong></span>
              <% } %>
            </div>

            <% if (post.tags?.length) { %>
              <div class="mb-2 fade-tags">
                <% post.tags.forEach(t => { %>
                  <span class="badge tag-anim bg-light text-primary border rounded-pill px-2 py-1 me-1">
                    #<%= t %>
                  </span>
                <% }) %>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Body -->
        <div class="card-body pt-2 pb-3">
          <p class="mb-0"><%= post.question %></p>
        </div>

        <hr class="my-0">

        <!-- Answers -->
        <div class="card-body">

          <h6 class="fw-semibold mb-3">Answers</h6>

          <% if (post.answers && post.answers.length) { %>

            <% post.answers.forEach(answer => { %>

              <div class="d-flex mb-3 border-start ps-3 answer-slide">

                <div class="avatar small-avatar pulse">
                  <%= answer.answeredBy?.name 
                        ? answer.answeredBy.name.split(' ').map(n=>n[0]).join('') 
                        : 'U' %>
                </div>

                <div>
                  <p class="mb-1"><%= answer.text %></p>
                  <small class="text-muted">
                    — <strong><%= answer.answeredBy ? answer.answeredBy.name : "Deleted User" %></strong>
                    &middot;
                    <%= new Date(answer.createdAt).toLocaleString() %>
                  </small>
                </div>

              </div>

            <% }) %>

          <% } else { %>
            <p class="text-muted"><small>No answers yet—be the first to reply!</small></p>
          <% } %>

          <!-- Reply -->
          <form action="/forum/<%= post._id %>/answer"
                method="POST"
                class="d-flex gap-2 mt-3 reply-expand">

            <input type="text"
                   name="text"
                   required
                   class="form-control form-control-sm rounded-3"
                   placeholder="Write your answer...">

            <button class="btn btn-primary btn-sm rounded-3">Reply</button>
          </form>

        </div>

      </div>

    <% }) %>

  <% } else { %>
    <p class="text-muted">No questions found for the selected class.</p>
  <% } %>

</div>

<%- include('../partials/footer') %>
