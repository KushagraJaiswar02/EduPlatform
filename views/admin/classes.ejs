<%- include('../partials/header') %>

<div class="container mt-4">
    <div class="row">

        
        <div class="col-md-7">
            <h2>Existing Classes</h2>
            <% if (classes && classes.length > 0) { %>
                <% classes.forEach(cls => { %>
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0">Class <%= cls.classNumber %></h5>
                        </div>
                        <ul class="list-group list-group-flush">
                            <% if (cls.subjects && cls.subjects.length > 0) { %>
                                <% cls.subjects.forEach(subject => { %>
                                    <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong><%= subject.name %></strong>
                                        <span class="badge bg-info rounded-pill">
                                        <%= subject.teacher ? subject.teacher.name : 'Unassigned' %>
                                        </span>
                                    </div>

                                    <!-- Reassign form -->
                                    <form action="/admin/reassign-teacher" method="POST" class="mt-2">
                                        <input type="hidden" name="classId" value="<%= cls._id %>">
                                        <input type="hidden" name="subjectName" value="<%= subject.name %>">
                                        <div class="row g-2 align-items-center">
                                        <div class="col-md-8">
                                            <select name="newTeacherId" class="form-select form-select-sm" required>
                                            <option value="">Select new teacher</option>
                                            <% teachers.forEach(teacher => { %>
                                                <option value="<%= teacher._id %>" 
                                                <%= subject.teacher && teacher._id.toString() === subject.teacher._id.toString() ? 'selected' : '' %>>
                                                <%= teacher.name %>
                                                </option>
                                            <% }) %>
                                            </select>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button type="submit" class="btn btn-sm btn-outline-primary w-100">
                                            Reassign
                                            </button>
                                        </div>
                                        </div>
                                    </form>
                                    </li>

                                <% }); %>
                            <% } else { %>
                                <li class="list-group-item text-muted">No subjects assigned.</li>
                            <% } %>
                            
                        </ul>
                        <form action="/admin/add-subject" method="POST" class="p-3 border-top bg-light">
                        <input type="hidden" name="classId" value="<%= cls._id %>">
                        <div class="row g-2">
                            <div class="col-md-5">
                            <input type="text" name="subjectName" class="form-control" placeholder="New Subject Name" required>
                            </div>
                            <div class="col-md-5">
                            <select name="subjectTeacher" class="form-select" required>
                                <option value="">Select Teacher</option>
                                <% teachers.forEach(teacher => { %>
                                <option value="<%= teacher._id %>"><%= teacher.name %></option>
                                <% }) %>
                            </select>
                            </div>
                            <div class="col-md-2">
                            <button type="submit" class="btn btn-sm btn-outline-primary w-100">Add</button>
                            </div>
                        </div>
                        </form>

                    </div>
                <% }); %>
            <% } else { %>
                <p>No classes found.</p>
            <% } %>
        </div>
    </div>
</div>

<script>
    document.getElementById('add-subject-btn').addEventListener('click', function() {
        const container = document.getElementById('subjects-container');
        const firstRow = container.querySelector('.subject-row');
        
        // Pehle row ko clone karein
        const newRow = firstRow.cloneNode(true);
        
        // Inputs ko reset karein
        newRow.querySelector('input[name="subjectName"]').value = '';
        newRow.querySelector('select[name="subjectTeacher"]').selectedIndex = 0;
        
        // Ek 'Remove' button add karein
        const removeBtnCol = document.createElement('div');
        removeBtnCol.className = 'col-12 text-end';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger mb-2';
        removeBtn.innerText = 'Remove';
        removeBtn.onclick = function() {
            container.removeChild(newRow);
        };
        
        // Row ko naye structure mein daalein (inputs upar, button neeche)
        const rowContent = newRow.innerHTML;
        newRow.innerHTML = ''; // Clear current content
        newRow.classList.remove('row', 'g-2', 'mb-2'); // Remove old classes
        newRow.className = 'subject-row-item border-top pt-2 mt-2'; // Add new container class
        
        const inputsDiv = document.createElement('div');
        inputsDiv.className = 'row g-2 mb-2';
        inputsDiv.innerHTML = rowContent;
        
        removeBtnCol.appendChild(removeBtn);
        newRow.appendChild(inputsDiv);
        newRow.appendChild(removeBtnCol);

        container.appendChild(newRow);
    });
</script>

<%- include('../partials/footer') %>