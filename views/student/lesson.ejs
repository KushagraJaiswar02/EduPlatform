<%- include('../partials/header') %>

<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent px-0">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/student/lessons">Lessons</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= lesson.title %></li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-md-8">
      <div class="d-flex align-items-start gap-3 mb-3">
        <div>
          <h1 class="h4 fw-bold"><%= lesson.title %></h1>
          <div class="text-muted small">
            By <strong><%= lesson.authorName || 'Teacher' %></strong>
            <% if (lesson.createdAt) { %> • <%= new Date(lesson.createdAt).toLocaleDateString() %><% } %>
            <% if (lesson.subject) { %> • <span class="badge bg-primary"><%= lesson.subject %></span><% } %>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body reading-font" style="line-height:1.7;">
          <!-- Main lesson content (HTML allowed) -->
          <%- lesson.content || '<p class="text-muted">No content available for this lesson.</p>' %>
        </div>
      </div>

      <% if (lesson.resources && lesson.resources.length) { %>
        <div class="mb-4" id="resources">
          <h5 class="mb-3">Resources</h5>
          <ul class="list-group list-group-flush">
            <% lesson.resources.forEach(function(res){ %>
              <% if (typeof res === 'string') { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <a href="<%= res %>" target="_blank" rel="noopener noreferrer"><%= res %></a>
                  </div>
                </li>
              <% } else { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= res.title || (res.url ? res.url.split('/').pop() : 'Resource') %></strong>
                    <% if (res.description) { %>
                      <div class="text-muted small"><%= res.description %></div>
                    <% } %>
                  </div>
                  <% if (res.url) { %>
                    <a href="<%= res.url %>" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-secondary">Open</a>
                  <% } %>
                </li>
              <% } %>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <div class="d-flex gap-2 mb-5">
        <a href="/student/lessons" class="btn btn-outline-secondary">← Back to Lessons</a>
        <% if (typeof prevLesson !== 'undefined' && prevLesson) { %>
          <a href="/student/lesson/<%= prevLesson._id %>" class="btn btn-outline-primary">Previous</a>
        <% } %>
        <% if (typeof nextLesson !== 'undefined' && nextLesson) { %>
          <a href="/student/lesson/<%= nextLesson._id %>" class="btn btn-outline-primary">Next</a>
        <% } %>

        <button id="markCompleteBtn" class="btn btn-success ms-auto">Mark Completed</button>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2">Lesson Overview</h6>
          <p class="small text-muted mb-1">Estimated time</p>
          <p class="fw-semibold mb-2"><%= lesson.estimatedTime || '10-20 mins' %></p>

          <p class="small text-muted mb-1">Progress</p>
          <div class="progress mb-3" style="height:10px;">
            <div class="progress-bar" role="progressbar" data-progress="<%= typeof lessonProgress !== 'undefined' ? lessonProgress : 0 %>" aria-valuenow="<%= typeof lessonProgress !== 'undefined' ? lessonProgress : 0 %>" aria-valuemin="0" aria-valuemax="100"></div>
          </div>

          <% if (typeof quiz !== 'undefined' && quiz) { %>
            <a href="/student/quiz/<%= quiz._id %>" class="btn btn-primary w-100 mb-2">Take Quiz</a>
          <% } %>

          <a href="#" class="btn btn-outline-secondary w-100 mb-2" onclick="window.print();return false;">Print Lesson</a>

          <hr>
          <h6 class="mb-2">Quick Links</h6>
          <ul class="list-unstyled small mb-0">
            <li><a href="#resources">Resources</a></li>
            <li><a href="#comments">Discussion</a></li>
            <li><a href="#notes">Add Notes</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  (function(){
    var btn = document.getElementById('markCompleteBtn');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      btn.disabled = true;
      btn.innerHTML = 'Marking...';
      try{
        var res = await fetch('/student/lesson/<%= lesson._id %>/complete', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (res.ok){
          btn.textContent = 'Completed ✓';
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-success');
        } else {
          btn.disabled = false;
          btn.textContent = 'Mark Completed';
          alert('Could not mark lesson as completed.');
        }
      } catch(e){
        btn.disabled = false;
        btn.textContent = 'Mark Completed';
        alert('Network error.');
      }
    });
  })();
</script>

<script>
  // set progress bar widths from data-progress to avoid EJS/% parsing in inline style
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.progress-bar[data-progress]').forEach(function(el){
      var p = parseInt(el.getAttribute('data-progress')) || 0;
      el.style.width = p + '%';
      el.textContent = p + '%';
    });
  });
</script>

<%- include('../partials/footer') %>
