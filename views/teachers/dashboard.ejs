<%- include('../partials/header') %>

<div class="container mt-4">
  <h2 class="fw-bold mb-4"><%= __('Teacher Dashboard') %></h2>

  <div class="row">

    <!-- LEFT PROFILE CARD -->
    <div class="col-lg-4 col-md-5">
      <% const t = (typeof user !== 'undefined' && user) ? user : (typeof currentUser !== 'undefined' ? currentUser : null); %>
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <div class="avatar mb-3" style="width:75px;height:75px;font-size:1.6rem;margin:auto;">
            <%= t && t.name ? t.name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase() : 'T' %>
          </div>

          <h4 class="mb-0"><%= t && t.name ? t.name : __('Teacher') %></h4>
          <p class="text-muted mb-1"><%= t && t.email ? t.email : '' %></p>
          <p><strong><%= __('Role') %>:</strong> <%= __('Teacher') %></p>

          <% if (classes && classes.length) { %>
            <p>
              <strong>Teaching Classes:</strong><br>
              <% classes.forEach(cls => { %>
                <span class="badge bg-primary text-light mb-1">Class <%= cls.classNumber %></span>
              <% }) %>
            </p>
          <% } else { %>
              <!-- DEBUG: toggle to show raw lessons data for troubleshooting -->
              <div class="mt-3">
                <button id="showLessonsDebugBtn" class="btn btn-outline-secondary btn-sm">Show Lessons Debug</button>
                <div id="lessonsDebug" style="display:none; margin-top:10px;">
                  <pre style="max-height:240px; overflow:auto; background:#f8f9fa; padding:10px; border:1px solid #e9ecef;">
        <%= JSON.stringify(myLessons || [], null, 2) %>
                  </pre>
                </div>
              </div>

            <p class="text-muted">No classes assigned.</p>
          <% } %>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3"><%= __('Quick Actions') %></h5>
          <a href="#collapseLesson" class="btn btn-primary w-100 mb-2">+ <%= __('Add Lesson') %></a>
          <a href="#collapseQuiz" class="btn btn-success w-100 mb-2">+ <%= __('Create Quiz') %></a>
          <a href="#myLessonsSection" class="btn btn-outline-primary w-100 mb-2">üìò <%= __('My Lessons') %></a>
          <a href="#myQuizzesSection" class="btn btn-outline-success w-100">üìù <%= __('My Quizzes') %></a>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDE CONTENT -->
    <div class="col-lg-8 col-md-7">

      <!-- ACCORDION: ADD LESSON & QUIZ -->
      <div class="accordion mb-4" id="teacherAccordion">

        <!-- ADD LESSON -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingLesson">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLesson">
              üìò <%= __('Add New Lesson') %>
            </button>
          </h2>

          <div id="collapseLesson" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <form action="/teacher/add-lesson" method="POST" enctype="multipart/form-data">
                <div class="row g-3">

                  <div class="col-md-6">
                    <label class="form-label"><%= __('Class') %></label>
                    <select name="classNumber" class="form-select" required>
                      <% if (typeof classes !== 'undefined' && classes && classes.length) { %>
                        <% classes.forEach(cls => { %>
                          <option value="<%= cls.classNumber %>">Class <%= cls.classNumber %></option>
                        <% }) %>
                      <% } else { %>
                        <option value=""><%= __('Select class') %></option>
                      <% } %>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label"><%= __('Subject') %></label>
                    <input type="text" name="subject" class="form-control" required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label"><%= __('Lesson Type') %></label>
                    <select name="lessonType" class="form-select">
                      <option value="core"><%= __('Core') %></option>
                      <option value="revision"><%= __('Revision') %></option>
                      <option value="practice"><%= __('Practice') %></option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label"><%= __('Difficulty Level') %></label>
                    <select name="difficultyLevel" class="form-select">
                      <option value="beginner"><%= __('Beginner') %></option>
                      <option value="intermediate"><%= __('Intermediate') %></option>
                      <option value="advanced"><%= __('Advanced') %></option>
                    </select>
                  </div>

                  <div class="col-12">
                    <label class="form-label"><%= __('Title') %></label>
                    <input type="text" name="title" class="form-control" required>
                  </div>

                  <div class="col-12">
                    <label class="form-label"><%= __('Content') %></label>
                    <textarea name="content" class="form-control" rows="4" required></textarea>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label"><%= __('Related To (optional)') %></label>
                    <select name="relatedTo" class="form-select">
                      <option value="">-- <%= __('None') %> --</option>
                      <% if (myLessons && myLessons.length) { %>
                        <% myLessons.forEach(l => { %>
                          <option value="<%= l._id %>"><%= l.title %></option>
                        <% }) %>
                      <% } %>
                    </select>
                  </div>

                  <div class="col-12" id="resources-section">
                    <label class="form-label"><%= __('Resources (URLs or text)') %></label>
                    <div id="resources-container">
                      <div class="input-group mb-2">
                        <input type="text" name="resources[]" class="form-control" placeholder="https://example.com/resource or short text">
                        <button type="button" class="btn btn-outline-danger remove-resource">Remove</button>
                      </div>
                    </div>
                    <button type="button" id="addResourceBtn" class="btn btn-sm btn-outline-primary">+ <%= __('Add Resource') %></button>
                  </div>

                  <div class="col-md-6 form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="liveSwitch" name="liveEnabled">
                    <label class="form-check-label" for="liveSwitch">Enable Live Lecture</label>
                  </div>

                  <div class="col-md-6" id="liveScheduleWrap" style="display:none;">
                    <label class="form-label">Schedule (optional)</label>
                    <input type="datetime-local" name="liveScheduledAt" class="form-control">
                    <div class="form-text">Optional scheduled start time for the live lecture.</div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Lecture Video (optional)</label>
                    <input type="file" name="video" accept="video/*" class="form-control">
                    <div class="form-text">Upload a lecture video. Students will be able to view and download it.</div>
                  </div>

                </div>
                <button class="btn btn-primary mt-3"><%= __('Add Lesson') %></button>
              </form>
            </div>
          </div>
        </div>

        <!-- CREATE QUIZ -->
        <div class="accordion-item mt-3">
          <h2 class="accordion-header" id="headingQuiz">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuiz">
              üìù <%= __('Create Quiz') %>
            </button>
          </h2>

          <div id="collapseQuiz" class="accordion-collapse collapse">
            <div class="accordion-body">
              <form action="/teacher/add-quiz" method="POST" id="quizForm">

                <div class="mb-3">
                  <label class="form-label"><%= __('Select Lesson') %></label>
                  <select name="lessonId" class="form-select" required>
                    <% if (myLessons && myLessons.length) { %>
                      <% myLessons.forEach(lesson => { %>
                        <option value="<%= lesson._id %>">
                          Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %> ‚Äî <%= lesson.title %>
                        </option>
                      <% }) %>
                    <% } else { %>
                      <option value=""><%= __('No lessons available') %></option>
                    <% } %>
                  </select>
                </div>

                <div id="questions-container"></div>

                <button type="button" class="btn btn-outline-primary btn-sm" id="addQuestionBtn">+ <%= __('Add Question') %></button>
                <button type="submit" class="btn btn-success"><%= __('Create Quiz') %></button>

              </form>
            </div>
          </div>
        </div>

      </div>

      <!-- MY LESSONS -->
      <h4 id="myLessonsSection" class="fw-bold mt-4 mb-3">üìò <%= __('My Lessons') %></h4>

      <% if (!myLessons || myLessons.length === 0) { %>
        <p class="text-muted"><%= __('You haven‚Äôt created any lessons yet.') %></p>
      <% } else { %>
        <div class="list-group mb-4">
          <% myLessons.forEach(lesson => { %>
            <div class="list-group-item d-flex align-items-start justify-content-between">
              <div>
                <strong><%= lesson.title %></strong>
                <span class="text-muted"> ¬∑ Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %></span>
                <div class="small text-muted"><%= lesson.subject %> | <%= lesson.lessonType %></div>
              </div>
              <div class="text-end">
                <% if (lesson.live && lesson.live.enabled) { %>
                  <span class="badge bg-success mb-2">Live Enabled</span>
                <% } %>
                <div>
                  <a href="/teacher/lesson/<%= lesson._id %>" class="btn btn-sm btn-outline-primary">Manage</a>
                  <% if (lesson.live && lesson.live.meetingUrl) { %>
                    <a href="<%= lesson.live.meetingUrl %>" target="_blank" class="btn btn-sm btn-primary ms-2">Join Live</a>
                    <button class="btn btn-sm btn-warning ms-2 toggle-live-btn" data-lesson-id="<%= lesson._id %>" data-active="<%= lesson.live.active ? '1' : '0' %>">
                      <%= lesson.live && lesson.live.active ? 'Stop Live' : 'Stop Live' %>
                    </button>
                  <% } else if (lesson.live && lesson.live.enabled) { %>
                    <!-- meetingUrl missing but live.enabled true: show toggle -->
                    <button class="btn btn-sm btn-warning ms-2 toggle-live-btn" data-lesson-id="<%= lesson._id %>" data-active="<%= lesson.live.active ? '1' : '0' %>">
                      <%= lesson.live && lesson.live.active ? 'Stop Live' : 'Start Live' %>
                    </button>
                  <% } else { %>
                    <!-- no live configured: offer to enable live -->
                    <form action="/teacher/lesson/<%= lesson._id %>/enable-live" method="POST" style="display:inline-block;">
                      <button class="btn btn-sm btn-outline-success ms-2">Enable Live</button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>

      <!-- MY QUIZZES -->
      <h4 id="myQuizzesSection" class="fw-bold mb-3">üìù <%= __('My Quizzes') %></h4>

      <% if (!myQuizzes || myQuizzes.length === 0) { %>
        <p class="text-muted"><%= __('You haven‚Äôt created any quizzes yet.') %></p>
      <% } else { %>
        <div class="list-group">
          <% myQuizzes.forEach(qz => { %>
            <div class="list-group-item">
              <strong><%= qz.lessonId ? qz.lessonId.title : __('Unknown Lesson') %></strong>
              <span class="text-muted">¬∑ Class <%= qz.lessonId && qz.lessonId.classRef ? qz.lessonId.classRef.classNumber : 'N/A' %></span>
              <div class="small text-muted"><%= qz.questions ? qz.questions.length : 0 %> <%= __('questions') %></div>
            </div>
          <% }) %>
        </div>
      <% } %>

    </div>
  </div>
</div>



<script>
  // Socket.IO for teacher dashboard: start/stop live sessions
    (function(){
      // wait until the whole page (including footer scripts like socket.io) is loaded
      window.addEventListener('load', function(){
        if (typeof io === 'undefined') return; // socket.io client not loaded
        const socket = io();

        // join rooms for lessons that have toggle buttons so teacher receives broadcasts
        document.querySelectorAll('.toggle-live-btn').forEach(btn => {
          const lessonId = btn.getAttribute('data-lesson-id');
          if (lessonId) socket.emit('joinLesson', { lessonId });
        });

        // handle button clicks
        document.querySelectorAll('.toggle-live-btn').forEach(btn => {
          btn.addEventListener('click', function(e){
            const lessonId = this.getAttribute('data-lesson-id');
            const currentlyActive = this.getAttribute('data-active') === '1';
            const newActive = !currentlyActive;
            // optimistic UI
            this.disabled = true;
            this.textContent = newActive ? 'Starting...' : 'Stopping...';
            // ensure the toggling socket is part of the room (server also emits back to socket)
            socket.emit('joinLesson', { lessonId });
            socket.emit('lesson:toggle', { lessonId, active: newActive });
          });
        });

        // listen for status updates from server
        socket.on('lesson:status', function(payload){
          if (!payload || !payload.lessonId) return;
          const btn = document.querySelector(`.toggle-live-btn[data-lesson-id="${payload.lessonId}"]`);
          if (btn){
            btn.disabled = false;
            btn.setAttribute('data-active', payload.active ? '1' : '0');
            if (payload.active){
              btn.classList.remove('btn-secondary');
              btn.classList.remove('btn-warning');
              btn.classList.add('btn-warning');
              btn.textContent = 'Stop Live';
            } else {
              btn.classList.remove('btn-warning');
              btn.classList.add('btn-secondary');
              btn.textContent = 'Start Live';
            }
          }
        });

        socket.on('lesson:toggle:error', function(err){
          alert(err && err.message ? err.message : 'Failed to toggle live state');
          // re-enable all buttons in case of error
          document.querySelectorAll('.toggle-live-btn').forEach(b => b.disabled = false);
        });
      });
    })();
</script>

<%- include('../partials/footer') %>