<%- include('../partials/header') %>

<div class="container mt-4">
  <h2 class="fw-bold mb-4"><%= __('Teacher Dashboard') %></h2>

  <div class="row">

    <!-- ===================== LEFT PROFILE CARD ===================== -->
    <div class="col-lg-4 col-md-5">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <div class="avatar mb-3" style="width:75px;height:75px;font-size:1.6rem;margin:auto;">
            <%= user.name.split(' ').map(n=>n[0]).slice(0,2).join('') %>
          </div>

          <h4 class="mb-0"><%= user.name %></h4>
          <p class="text-muted mb-1"><%= user.email %></p>
          <p><strong>Role:</strong> Teacher</p>

          <% if (classes && classes.length) { %>
            <p>
              <strong>Teaching Classes:</strong><br>
              <% classes.forEach(cls => { %>
                <span class="badge bg-primary text-light mb-1">Class <%= cls.classNumber %></span>
              <% }) %>
            </p>
          <% } else { %>
            <p class="text-muted">No classes assigned.</p>
          <% } %>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Quick Actions</h5>
          <a href="#collapseLesson" class="btn btn-primary w-100 mb-2">+ Add Lesson</a>
          <a href="#collapseQuiz" class="btn btn-success w-100 mb-2">+ Create Quiz</a>
          <a href="#myLessonsSection" class="btn btn-outline-primary w-100 mb-2">üìò My Lessons</a>
          <a href="#myQuizzesSection" class="btn btn-outline-success w-100">üìù My Quizzes</a>
        </div>
      </div>
    </div>

    <!-- ===================== RIGHT SIDE CONTENT ===================== -->
    <div class="col-lg-8 col-md-7">

      <!-- ACCORDION: ADD LESSON & QUIZ -->
      <div class="accordion mb-4" id="teacherAccordion">

        <!-- ========== ADD LESSON ========== -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingLesson">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLesson">
              üìò Add New Lesson
            </button>
          </h2>

          <div id="collapseLesson" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <form action="/teacher/add-lesson" method="POST">
                <div class="row g-3">

                  <div class="col-md-6">
                    <label class="form-label">Class</label>
                    <select name="classNumber" class="form-select" required>
                      <% classes.forEach(cls => { %>
                        <option value="<%= cls.classNumber %>">
                          Class <%= cls.classNumber %>
                        </option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Subject</label>
                    <input type="text" name="subject" class="form-control" required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Lesson Type</label>
                    <select name="lessonType" class="form-select">
                      <option value="core">Core</option>
                      <option value="revision">Revision</option>
                      <option value="practice">Practice</option>
                    </select>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-control" required>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Content</label>
                    <textarea name="content" class="form-control" rows="4" required></textarea>
                  </div>

                </div>
                <button class="btn btn-primary mt-3">Add Lesson</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ========== CREATE QUIZ ========== -->
        <div class="accordion-item mt-3">
          <h2 class="accordion-header" id="headingQuiz">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuiz">
              üìù Create Quiz
            </button>
          </h2>

          <div id="collapseQuiz" class="accordion-collapse collapse">
            <div class="accordion-body">

              <form action="/teacher/add-quiz" method="POST" id="quizForm">

                <div class="mb-3">
                  <label class="form-label">Select Lesson</label>
                  <select name="lessonId" class="form-select" required>
                    <% myLessons.forEach(lesson => { %>
                      <option value="<%= lesson._id %>">
                        Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %> ‚Äî <%= lesson.title %>
                      </option>
                    <% }) %>
                  </select>
                </div>

                <div id="questions-container"></div>

                <button type="button" class="btn btn-outline-primary btn-sm" id="addQuestionBtn">+ Add Question</button>
                <button type="submit" class="btn btn-success">Create Quiz</button>

              </form>

            </div>
          </div>
        </div>

      </div>

      <!-- ===================== MY LESSONS ===================== -->
      <h4 id="myLessonsSection" class="fw-bold mt-4 mb-3">üìò My Lessons</h4>

      <% if (!myLessons || myLessons.length === 0) { %>
        <p class="text-muted">You haven‚Äôt created any lessons yet.</p>
      <% } else { %>
        <div class="list-group mb-4">
          <% myLessons.forEach(lesson => { %>
            <div class="list-group-item">
              <strong><%= lesson.title %></strong>
              <span class="text-muted">
                ¬∑ Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %>
              </span>
              <div class="small text-muted"><%= lesson.subject %> | <%= lesson.lessonType %></div>
            </div>
          <% }) %>
        </div>
      <% } %>

      <!-- ===================== MY QUIZZES ===================== -->
      <h4 id="myQuizzesSection" class="fw-bold mb-3">üìù My Quizzes</h4>

      <% if (!myQuizzes || myQuizzes.length === 0) { %>
        <p class="text-muted">You haven‚Äôt created any quizzes yet.</p>
      <% } else { %>
        <div class="list-group">
          <% myQuizzes.forEach(qz => { %>
            <div class="list-group-item">

              <strong>
                <%= qz.lessonId ? qz.lessonId.title : "Unknown Lesson" %>
              </strong>

              <span class="text-muted">
                ¬∑ Class <%= 
                    qz.lessonId && qz.lessonId.classRef 
                      ? qz.lessonId.classRef.classNumber 
                      : "N/A" 
                %>
              </span>

              <div class="small text-muted">
                <%= qz.questions ? qz.questions.length : 0 %> questions
              </div>

            </div>
          <% }) %>
        </div>
      <% } %>

    </div>
  </div>
</div>


<!-- ========== JS for Adding Quiz Questions ========== -->
<script>
  const container = document.getElementById('questions-container');
  const addBtn = document.getElementById('addQuestionBtn');
  let qIndex = 0;

  addBtn?.addEventListener('click', () => {
    qIndex++;
    const box = document.createElement('div');
    box.className = "mb-3 border rounded p-3";
    box.innerHTML = `
      <label class="form-label">Question ${qIndex}</label>
      <input name="questions[${qIndex}][question]" class="form-control mb-2" required>

      <label class="form-label">Answer</label>
      <input name="questions[${qIndex}][answer]" class="form-control" required>
    `;
    container.appendChild(box);
  });
</script>

<%- include('../partials/footer') %>
