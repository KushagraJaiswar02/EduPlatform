<%- include('../partials/header') %>

<div class="container mt-4">
  <h2 class="fw-bold mb-4"><%= __('Teacher Dashboard') %></h2>

  <div class="row">

    <!-- ===================== LEFT PROFILE CARD ===================== -->
    <div class="col-lg-4 col-md-5">
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <div class="avatar mb-3" style="width:75px;height:75px;font-size:1.6rem;margin:auto;">
            <%= user.name.split(' ').map(n=>n[0]).slice(0,2).join('') %>
          </div>

          <h4 class="mb-0"><%= user.name %></h4>
          <p class="text-muted mb-1"><%= user.email %></p>
          <p><strong>Role:</strong> Teacher</p>

          <% if (classes && classes.length) { %>
            <p>
              <strong>Teaching Classes:</strong><br>
              <% classes.forEach(cls => { %>
                <span class="badge bg-primary text-light mb-1">Class <%= cls.classNumber %></span>
              <% }) %>
            </p>
          <% } else { %>
              <!-- DEBUG: toggle to show raw lessons data for troubleshooting -->
              <div class="mt-3">
                <button id="showLessonsDebugBtn" class="btn btn-outline-secondary btn-sm">Show Lessons Debug</button>
                <div id="lessonsDebug" style="display:none; margin-top:10px;">
                  <pre style="max-height:240px; overflow:auto; background:#f8f9fa; padding:10px; border:1px solid #e9ecef;">
        <%= JSON.stringify(myLessons || [], null, 2) %>
                  </pre>
                </div>
              </div>

            <p class="text-muted">No classes assigned.</p>
          <% } %>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Quick Actions</h5>
          <a href="#collapseLesson" class="btn btn-primary w-100 mb-2">+ Add Lesson</a>
          <a href="#collapseQuiz" class="btn btn-success w-100 mb-2">+ Create Quiz</a>
          <a href="#myLessonsSection" class="btn btn-outline-primary w-100 mb-2">üìò My Lessons</a>
          <a href="#myQuizzesSection" class="btn btn-outline-success w-100">üìù My Quizzes</a>
        </div>
      </div>
    </div>

    <!-- ===================== RIGHT SIDE CONTENT ===================== -->
    <div class="col-lg-8 col-md-7">

      <!-- ACCORDION: ADD LESSON & QUIZ -->
      <div class="accordion mb-4" id="teacherAccordion">

        <!-- ========== ADD LESSON ========== -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingLesson">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLesson">
              üìò Add New Lesson
            </button>
          </h2>

          <div id="collapseLesson" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <form action="/teacher/add-lesson" method="POST" enctype="multipart/form-data">
                <div class="row g-3">

                  <div class="col-md-6">
                    <label class="form-label">Class</label>
                    <select name="classNumber" class="form-select" required>
                      <% classes.forEach(cls => { %>
                        <option value="<%= cls.classNumber %>">
                          Class <%= cls.classNumber %>
                        </option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Subject</label>
                    <input type="text" name="subject" class="form-control" required>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Lesson Type</label>
                    <select name="lessonType" class="form-select">
                      <option value="core">Core</option>
                      <option value="revision">Revision</option>
                      <option value="practice">Practice</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Difficulty Level</label>
                    <select name="difficultyLevel" class="form-select">
                      <option value="beginner">Beginner</option>
                      <option value="intermediate">Intermediate</option>
                      <option value="advanced">Advanced</option>
                    </select>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-control" required>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Content</label>
                    <textarea name="content" class="form-control" rows="4" required></textarea>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Related To (optional)</label>
                    <select name="relatedTo" class="form-select">
                      <option value="">-- None --</option>
                      <% if (myLessons && myLessons.length) { %>
                        <% myLessons.forEach(l => { %>
                          <option value="<%= l._id %>"><%= l.title %></option>
                        <% }) %>
                      <% } %>
                    </select>
                  </div>

                  <div class="col-12" id="resources-section">
                    <label class="form-label">Resources (URLs or text)</label>
                    <div id="resources-container">
                      <div class="input-group mb-2">
                        <input type="text" name="resources[]" class="form-control" placeholder="https://example.com/resource or short text">
                        <button type="button" class="btn btn-outline-danger remove-resource">Remove</button>
                      </div>
                    </div>
                    <button type="button" id="addResourceBtn" class="btn btn-sm btn-outline-primary">+ Add Resource</button>
                  </div>

                  <div class="col-md-6 form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="liveSwitch" name="liveEnabled">
                    <label class="form-check-label" for="liveSwitch">Enable Live Lecture</label>
                  </div>

                  <div class="col-md-6" id="liveScheduleWrap" style="display:none;">
                    <label class="form-label">Schedule (optional)</label>
                    <input type="datetime-local" name="liveScheduledAt" class="form-control">
                    <div class="form-text">Optional scheduled start time for the live lecture.</div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Lecture Video (optional)</label>
                    <input type="file" name="video" accept="video/*" class="form-control">
                    <div class="form-text">Upload a lecture video. Students will be able to view and download it.</div>
                  </div>

                </div>
                <button class="btn btn-primary mt-3">Add Lesson</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ========== CREATE QUIZ ========== -->
        <div class="accordion-item mt-3">
          <h2 class="accordion-header" id="headingQuiz">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQuiz">
              üìù Create Quiz
            </button>
          </h2>

          <div id="collapseQuiz" class="accordion-collapse collapse">
            <div class="accordion-body">

              <form action="/teacher/add-quiz" method="POST" id="quizForm">

                <div class="mb-3">
                  <label class="form-label">Select Lesson</label>
                  <select name="lessonId" class="form-select" required>
                    <% myLessons.forEach(lesson => { %>
                      <option value="<%= lesson._id %>">
                        Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %> ‚Äî <%= lesson.title %>
                      </option>
                    <% }) %>
                  </select>
                </div>

                <div id="questions-container"></div>

                <button type="button" class="btn btn-outline-primary btn-sm" id="addQuestionBtn">+ Add Question</button>
                <button type="submit" class="btn btn-success">Create Quiz</button>

              </form>

            </div>
          </div>
        </div>

      </div>

      <!-- ===================== MY LESSONS ===================== -->
      <h4 id="myLessonsSection" class="fw-bold mt-4 mb-3">üìò My Lessons</h4>

      <% if (!myLessons || myLessons.length === 0) { %>
        <p class="text-muted">You haven‚Äôt created any lessons yet.</p>
      <% } else { %>
        <div class="list-group mb-4">
          <% myLessons.forEach(lesson => { %>
            <div class="list-group-item d-flex align-items-start justify-content-between">
              <div>
                <strong><%= lesson.title %></strong>
                <span class="text-muted"> ¬∑ Class <%= lesson.classRef ? lesson.classRef.classNumber : 'N/A' %></span>
                <div class="small text-muted"><%= lesson.subject %> | <%= lesson.lessonType %></div>
              </div>
              <div class="text-end">
                <% if (lesson.live && lesson.live.enabled) { %>
                  <span class="badge bg-success mb-2">Live Enabled</span>
                <% } %>
                <div>
                  <a href="/teacher/lesson/<%= lesson._id %>" class="btn btn-sm btn-outline-primary">Manage</a>
                  <% if (lesson.live && lesson.live.meetingUrl) { %>
                    <a href="<%= lesson.live.meetingUrl %>" target="_blank" class="btn btn-sm btn-primary ms-2">Join Live</a>
                    <button class="btn btn-sm btn-warning ms-2 toggle-live-btn" data-lesson-id="<%= lesson._id %>" data-active="<%= lesson.live.active ? '1' : '0' %>">
                      <%= lesson.live && lesson.live.active ? 'Stop Live' : 'Stop Live' %>
                    </button>
                  <% } else if (lesson.live && lesson.live.enabled) { %>
                    <!-- meetingUrl missing but live.enabled true: show toggle -->
                    <button class="btn btn-sm btn-warning ms-2 toggle-live-btn" data-lesson-id="<%= lesson._id %>" data-active="<%= lesson.live.active ? '1' : '0' %>">
                      <%= lesson.live && lesson.live.active ? 'Stop Live' : 'Start Live' %>
                    </button>
                  <% } else { %>
                    <!-- no live configured: offer to enable live -->
                    <form action="/teacher/lesson/<%= lesson._id %>/enable-live" method="POST" style="display:inline-block;">
                      <button class="btn btn-sm btn-outline-success ms-2">Enable Live</button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>

      <!-- ===================== MY QUIZZES ===================== -->
      <h4 id="myQuizzesSection" class="fw-bold mb-3">üìù My Quizzes</h4>

      <% if (!myQuizzes || myQuizzes.length === 0) { %>
        <p class="text-muted">You haven‚Äôt created any quizzes yet.</p>
      <% } else { %>
        <div class="list-group">
          <% myQuizzes.forEach(qz => { %>
            <div class="list-group-item">

              <strong>
                <%= qz.lessonId ? qz.lessonId.title : "Unknown Lesson" %>
              </strong>

              <span class="text-muted">
                ¬∑ Class <%= 
                    qz.lessonId && qz.lessonId.classRef 
                      ? qz.lessonId.classRef.classNumber 
                      : "N/A" 
                %>
              </span>

              <div class="small text-muted">
                <%= qz.questions ? qz.questions.length : 0 %> questions
              </div>

            </div>
          <% }) %>
        </div>
      <% } %>

    </div>
  </div>
</div>


<!-- ========== JS for Adding Quiz Questions ========== -->
<script>
  const container = document.getElementById('questions-container');
  const addBtn = document.getElementById('addQuestionBtn');
  let qIndex = 0;

  addBtn?.addEventListener('click', () => {
    qIndex++;
    const box = document.createElement('div');
    box.className = "mb-3 border rounded p-3";
    box.innerHTML = `
      <label class="form-label">Question ${qIndex}</label>
      <input name="questions[${qIndex}][question]" class="form-control mb-2" required>

      <label class="form-label">Answer</label>
      <input name="questions[${qIndex}][answer]" class="form-control" required>
    `;
    container.appendChild(box);
  });

  // Resources dynamic inputs for Add Lesson
  const resContainer = document.getElementById('resources-container');
  const addResBtn = document.getElementById('addResourceBtn');

  function makeResourceRow(value = ''){
    const wrap = document.createElement('div');
    wrap.className = 'input-group mb-2';
    wrap.innerHTML = `
      <input type="text" name="resources[]" class="form-control" value="${value.replace(/\"/g,'&quot;')}" placeholder="https://example.com/resource or short text">
      <button type="button" class="btn btn-outline-danger remove-resource">Remove</button>
    `;
    return wrap;
  }

  addResBtn?.addEventListener('click', () => {
    resContainer.appendChild(makeResourceRow(''));
  });

  resContainer?.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('remove-resource')){
      const row = e.target.closest('.input-group');
      row?.remove();
    }
  });

  // Live lecture UI: show/hide schedule input
  const liveSwitch = document.getElementById('liveSwitch');
  const liveScheduleWrap = document.getElementById('liveScheduleWrap');
  if (liveSwitch) {
    liveSwitch.addEventListener('change', function(){
      if (this.checked) liveScheduleWrap.style.display = '';
      else liveScheduleWrap.style.display = 'none';
    });
  }
</script>

<script>
  // Socket.IO for teacher dashboard: start/stop live sessions
    (function(){
      // wait until the whole page (including footer scripts like socket.io) is loaded
      window.addEventListener('load', function(){
        if (typeof io === 'undefined') return; // socket.io client not loaded
        const socket = io();

        // join rooms for lessons that have toggle buttons so teacher receives broadcasts
        document.querySelectorAll('.toggle-live-btn').forEach(btn => {
          const lessonId = btn.getAttribute('data-lesson-id');
          if (lessonId) socket.emit('joinLesson', { lessonId });
        });

        // handle button clicks
        document.querySelectorAll('.toggle-live-btn').forEach(btn => {
          btn.addEventListener('click', function(e){
            const lessonId = this.getAttribute('data-lesson-id');
            const currentlyActive = this.getAttribute('data-active') === '1';
            const newActive = !currentlyActive;
            // optimistic UI
            this.disabled = true;
            this.textContent = newActive ? 'Starting...' : 'Stopping...';
            // ensure the toggling socket is part of the room (server also emits back to socket)
            socket.emit('joinLesson', { lessonId });
            socket.emit('lesson:toggle', { lessonId, active: newActive });
          });
        });

        // listen for status updates from server
        socket.on('lesson:status', function(payload){
          if (!payload || !payload.lessonId) return;
          const btn = document.querySelector(`.toggle-live-btn[data-lesson-id="${payload.lessonId}"]`);
          if (btn){
            btn.disabled = false;
            btn.setAttribute('data-active', payload.active ? '1' : '0');
            if (payload.active){
              btn.classList.remove('btn-secondary');
              btn.classList.remove('btn-warning');
              btn.classList.add('btn-warning');
              btn.textContent = 'Stop Live';
            } else {
              btn.classList.remove('btn-warning');
              btn.classList.add('btn-secondary');
              btn.textContent = 'Start Live';
            }
          }
        });

        socket.on('lesson:toggle:error', function(err){
          alert(err && err.message ? err.message : 'Failed to toggle live state');
          // re-enable all buttons in case of error
          document.querySelectorAll('.toggle-live-btn').forEach(b => b.disabled = false);
        });
      });
    })();
</script>

<%- include('../partials/footer') %>
